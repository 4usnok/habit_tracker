# SPA веб-приложения: трекер привычек

Приложение для работы с Telegram и рассылками напоминаний

SPA веб-приложение, где бэкенд-сервер возвращает клиенту JSON-структуры. 
LMS-система, в которой каждый желающий может размещать свои полезные материалы или курсы.

# Инструкция по установке и использованию разработанного функционала приложения
1. Клонируйте репозиторий:
```
git clone https://github.com/4usnok/Project_5_Habit_tracker.git
```
2. Активируйте виртуальное окружение poetry:
```
poetry shell
```
3. Установите зависимости poetry:
```
poetry install
```
# Содержание проекта
## Приложение `habits`
1. `models.py`:
* Модель привычки -> `Habit`
2. `pagination.py`:
* Пагинация с количеством элементов на страницу 5 -> `HabitPagination`
3. `permissions.py`:
* Пользовательское разрешение, разрешающее владельцу только доступ -> `IsOwner`
4. `serializers.py`:
* Сериализатор для валидации КРУД -> `HabitValidSerializer`
* Сериализатор для привычки -> `HabitSerializer`
5. `services.py`:
* Преобразования сообщения -> `send_tg_message`
6. `tasks.py`:
* Для post-запроса в ТГ -> `get_info`
7. `validators.py`:
* Валидатор для проверки, что заполнено только одно из полей -> `RewardOrRelatedHabitValidator`
* Валидатор для проверки, что время выполнения должно быть не больше 120 секунд -> `FillTimeValidator`
* Валидатор для проверки, попадание в связанные привычки только привычек с признаком приятной привычки -> 
`PleasantHabitInRelatedHabitValidator`
* Валидатор для проверки, что у приятной привычки не может быть вознаграждения или связанной привычки ->
`PleasantHabitValidator`
* Валидатор для проверки, что нельзя выполнять привычку реже, чем 1 раз в 7 дней -> 
`NumberOfHabitsCompletedValidator`
8. `views.py`:
* Пагинация -> `MyView`
* Просмотр списка привычек владельца -> `ListPrivateAPIViewPermissions`
* Просмотр публичного списка владельца -> `ListPublicAPIViewPermissions`
* Создание постов -> `CreateAPIViewPermissions`
* Пользователь имеет право просматривать только свои посты -> `RetrieveAPIViewPermissions`
* Пользователь имеет право редактировать только свои посты -> `UpdateAPIViewPermissions`
* Пользователь имеет право удалять только свои посты -> `DestroyAPIViewPermissions`
9. `tests.py`:
* Файл для тестов

## Приложение `users`
Приложение предназначенное для работы с пользователями
1. `models.py`:
* Модель пользователя `User`
2. `serializers.py`:
* Сериализатор для модели `User` -> `RegistrationSerializer`
* Сериализатор для работы с токеном -> `MyTokenObtainPairSerializer`
3. `views.py`:
* `CreateUser` -> Создание/регистрация пользователя
* `UsersListAPIView` -> Просмотр списка пользователей
* `RetrieveUserAPIView` -> Просмотр конкретного пользователя
* `MyTokenObtainPairView` -> Получение JWT-токена
* `my_protected_view` -> Валидация авторизации
4. Содержит `tests.py`:
* Файл для тестов

## Прочие файлы
1. `telegram_bot.py` -> содержит функционал для работы с телеграм-ботом
2. `pyproject.toml` -> файл poetry с зависимостями и настройками
3. `README.md` -> описание проекта
4. `env.sample.txt` -> Заполняется в первую очередь(предназначен для заполнений host, port, пароля от бд, названия бд и тд.)
5. `redis` -> директория с брокером redis

# Работа с программой
1. Чтобы осуществить работу с телеграм ботом, необходимо выполнить следующие шаги:
* Запустить redis-сервер: `./redis-server.exe`
* Запустить worker: `celery -A config worker -l INFO`
* Запуск бота происходит из корня проекта: `python telegram_bot.py`
2. Запуск сервера осуществляется командой: `python manage.py runserver`

## Инструкции по настройке удаленного сервера и деплоя

# Создание и настройка виртуальной машины и сервера

Шаг 1. Создание виртуальной машины и обновление системы:
1. Создание ВМ происходит на Yandex Cloud:
`console.yandex.cloud/`
Советы по работе с ВМ:
а) Лучше всего указывать тот username, который был указан при создании ssh-ключей
б) ip следует указать в секретах -> публичным
в) публичный и приватный ключи создаются парами, поэтому следует указывать их одинаковыми
(например rsa-ключи должны быть и приватным, и публичным)
г) чтобы посмотреть полный, необрезанный приватный ключ, следует использовать команду:
`cat ~/.ssh/id_rsa`
д) чтобы публичный ключ, следует использовать команду:
`cat ~/.ssh/id_rsa.pub`

2. Перед подключением к ВМ, необходимо убедиться, что все пакеты имеют актуальные версии, а система имеет рабочее состояние
Шаг 1. Команда для обновления списка пакетов:
`sudo apt update`
Шаг 2. Команда для обновления всех установленных пакетов до их последних версий:
`sudo apt upgrade`

4. В терминале `Bash` или `Powershell` необходимо ввести команду, чтобы подключить к ВМ. Обычно, команда в характеристиках ВМ
на сервисе Yandex Cloud. Примерная структура будет `ssh username@1.234.567.89`, где: 
username -> это имя пользователя ВМ
1.234.567.89 -> публичный id

Шаг 2. Установка Докера состоит из последовательности команд, которые можно найти по ссылке в документации:
https://docs.docker.com/engine/install/ubuntu/

Шаг 3. Настройка файрвола
Шаг 1. Сначала проверьте состояние файрвола с помощью команды:
`sudo ufw status`
Если файрвол отключен, активируйте его:
`sudo ufw enable`

Шаг 2. Теперь откройте необходимые порты:
Порт 80 для HTTP:
`sudo ufw allow 80/tcp`
Порт 443 для HTTPS:
`sudo ufw allow 443/tcp`

Шаг 3. Порт 22.
Чтобы обеспечить доступ к вашему серверу по SSH, необходимо не забыть открыть порт 22. 
Открытие порта 22:
`sudo ufw allow 22/tcp`

Шаг 4. Проверьте настройки файрвола.
После добавления портов, проверьте состояние файрвола снова, чтобы убедиться, что порт 22 также открыт:
`sudo ufw status`

Ожидаемый результат:
В результате выполнения команды вы должны увидеть, что порт 22 находится в состоянии ALLOW наряду с портами 80 и 443. 
Это означает, что ваш сервер будет доступен для SSH-подключений, а также для веб-трафика.

Теперь ваш сервер безопасен и доступен для управления через SSH, а также для обработки HTTP и HTTPS запросов.

# Ручной деплой приложения

Ручной деплой состоит из нескольких шагов:
Шаг 1. Подключение к ВМ 
В `Bash` или `Powershell` необходимо ввести команду:
`ssh username@1.234.567.89`, где
username -> это никнейм ВМ
1.234.567.89 -> это публичный IPv4

Шаг 2. Клонирование репозитория:
команда -> `git clone ssh-код репозитория`

Шаг 3. Права доступа
Настройка прав пользователя иногда может потребоваться и она состоит из следующих шагов:
Шаг 1. Добавьте пользователя в группу docker:
`sudo usermod -aG docker $USER`
Шаг 2. Применить изменения групп (выйдите и войдите заново, или выполните):
`newgrp docker`
Шаг 3. Проверить, что пользователь добавлен в группу docker:
`groups`
Шаг 4. Проверить работу Docker:
`docker ps`

Шаг 4. Проверка и подгрузка недостающих файлов:
Выполните команду для проверки доступных файлов:
Шаг 1. После того, как мы склонировали проект, необходимо зайти в его корневую директорию:
`cd DZ5_DRF_materials_apps`
Шаг 2. Проверить наличие веток:
` git branch -r`
Шаг 3. Подгрузка недостающих файлов:
Баш может не найти нужные для деплоя файлы. В этом случае, необходимо будет обратиться на удалённый репозиторий, 
вместе с этим, баш подгрузит все недостающие файлы:
Команда -> `git ls-tree -r origin/homework_35_2 —name-only`, где нужно поменять homework_35_2 на свою ветку
`origin` -> это для удалённых веток, поэтому необходимо оставить

Шаг 5. Запуск docker-compose или по другому -> деплой:
`docker compose up -d`

# Деплой по методу CI
Деплой по методу CI осуществляется на гитхабе во вкладке Actions, настройки сервера и 
контейнера находятся в директории: `/.github/workflows` в файле `ci.yml`

# Полезные команды
* Запуск сервера: `python manage.py runserver`,
* Создание суперюзера(админка): `python manage.py createsuperuser`,
* Создание миграций: `python manage.py makemigrations`,
* Сохранение миграций: `python manage.py migrate`,
* Откат всех миграций: `python manage.py migrate name_migration`, где `name_migration` -> название миграции.
* Создание фикстуры для модели пользователей `User`: `python -Xutf8 manage.py dumpdata users.User --output users_fixture.json --indent 4`
* Создание фикстуры для модели платежей `Payments`: `python -Xutf8 manage.py dumpdata users.Payments --output payments_fixture.json --indent 4`
* Создания файла с покрытием `.coverage`: `coverage run --source='.' manage.py test`
* Посмотреть покрытие unit-тестами: `coverage report`
* Запуск обработчика очереди (worker) для получения задач и их выполнения: `celery -A config worker -l INFO`
* Запуск redis-server: `./redis-server.exe`
* Запуск redis-cli: `./redis-cli.exe`
* Сборка контейнера: `docker build -t habit_tracker-app .`
* Просмотр образов: `docker images`
* Удаление висячих образов: `docker image prune`
